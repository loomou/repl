const c=self;let i,r,n;const E=new TextDecoder,a=new Map;let h=/\/preview\/[^\/]+\.(js|ts|jsx|tsx|html|css|vue)(\?.*)?/;c.addEventListener("install",e=>{e.waitUntil(self.skipWaiting())}),c.addEventListener("activate",e=>{e.waitUntil(self.clients.claim()),c.clients.matchAll({type:"all"}).then(t=>{t.forEach(s=>{s.postMessage({type:"SERVICE_ACTIVATE"})})})}),c.addEventListener("fetch",async e=>{e.request.method==="GET"&&h.test(e.request.url)&&e.respondWith(d(e.request)),e.request.method==="GET"&&e.request.url.endsWith("/@hmr/client")&&e.respondWith(d(e.request))}),c.onmessage=({data:e,ports:t,source:s})=>{e.type==="SERVICE_CONFIG"&&(r&&r.close(),(t==null?void 0:t.length)===1&&(n=t[0]),f(e)),e.type==="CLIENT_LOAD"&&s.postMessage({type:"HMR_INIT",channelId:i})};function u(e){const t=a.get(e.req.url);t&&t.forEach(s=>{s.resolve(e.compiledCode)})}function p(e){const t=a.get(e.req);t&&t.forEach(s=>{s.reject(e.req)})}function f(e){e==null||e.config,n&&(n.onmessage=async({data:t})=>{switch(t.type){case"GET_CODE":{u(t);break}}}),i=e.channelId,r=new BroadcastChannel(`PREVIEW_CHANNEL_${e.channelId}`),r.addEventListener("message",async({data:t})=>{switch(t.type){case"GET_ERROR":{p(t);break}case"CHANNEL_CLOSE":(r==null?void 0:r.name)===`PREVIEW_CHANNEL_${t.channelId}`&&(r.close(),r=null,a.forEach(s=>{s.forEach(l=>{l.reject()})}))}})}async function d(e){let t;try{t=await new Promise((s,l)=>{let o=a.get(e.url);o?o.add({request:e,resolve:s,reject:l}):(n==null||n.postMessage({type:"FETCH_CODE",req:{url:e.url,method:e.method,referrer:e.referrer,originalUrl:e.url}}),o=new Set([{request:e,resolve:s,reject:l}]),a.set(e.url,o))})}catch(s){throw new Error(s)}return a.delete(e.url),new Response(t instanceof ArrayBuffer?E.decode(t):t,{headers:{"Content-Type":e.url.includes(".html")?"text/html":"application/javascript"}}).clone()}
